#!python

import sys
import boto3



def check_args(args):
  if len(args) - 1 < 3:
    print ("\nNeed at least 3 arguments. Please use form 'python ./clean_rds_snapshots.py {DB_IDENTIFIER} {DELETE_OLDEST_SNAPSHOT} {NUM_SNAPSHOTS_TO_KEEP} {AWS_PROFILE}'")
    return False

  if args[2] not in ['True', 'False']:
    print ("\nSecond argument should be 'True' or 'False'. Please use form 'python ./clean_rds_snapshots.py {DB_IDENTIFIER} {DELETE_OLDEST_SNAPSHOT} {NUM_SNAPSHOTS_TO_KEEP} {AWS_PROFILE}'")
    return False

  return True



def check_num_environment_db_snapshots(client, db_identifier):
  response = client.describe_db_snapshots(
    DBInstanceIdentifier=db_identifier,
    SnapshotType='manual'
  )

  return response['DBSnapshots']



def get_num_all_manual_snapshots(client):
  response = client.describe_db_snapshots(
    SnapshotType='manual'
  )

  return len(response['DBSnapshots'])



def delete_snapshot(client, snapshots):
  snapshot_to_delete = sorted(snapshots, key = lambda x : x['SnapshotCreateTime'])[0]

  print(f'\nSnapshot To Delete: {snapshot_to_delete}')

  response = client.delete_db_snapshot(
    DBSnapshotIdentifier=snapshot_to_delete['DBSnapshotIdentifier']
  )

  print(f'\nDeletion Status: {response["DBSnapshot"]["Status"]}')

  return True



def main(args):
  if not check_args(args):
    exit(1)

  if len(args) > 4:
    session = boto3.Session(profile_name=args[4])
    client = session.client('rds')
  else:
    client = boto3.client('rds', region_name='us-west-2') #hardcoding the region for now...

  db_env_snapshots = check_num_environment_db_snapshots(client, args[1])

  number_of_snapshots = len(db_env_snapshots)

  print(f'\nNumber of snapshots for this DB identifier: {number_of_snapshots}')

  if number_of_snapshots > int(args[3]):
    delete_snapshot(client, db_env_snapshots)
  else:
    print(f'\n{args[3]} or fewer snapshots are present, none need to be deleted')

    num_all_manual_snapshots = get_num_all_manual_snapshots(client)

    if num_all_manual_snapshots >= 100:
      print(f'\nThe limit for manual snapshots is 100, there are {num_all_manual_snapshots} currently present for this region.  None can be automatically delted since they are not a part of this environment.  Please manually remove snapshots and rerun this pipeline. Please see https://docs.aws.amazon.com/AmazonRDS/latest/UserGuide/CHAP_Limits.html for more details')
      exit(1)



main(sys.argv)
